<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê´€ë¦¬ì ê¸€ì“°ê¸° - Joyban</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .write-container {
        max-width: 800px;
        margin: 3rem auto;
        padding: 2rem;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
      }
      .form-control {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }
      textarea.form-control {
        height: 300px;
        resize: vertical;
      }
      .btn-submit {
        width: 100%;
        padding: 1rem;
        background: #2c3e50;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
      }
      .btn-submit:hover {
        background: #1a252f;
      }
      .file-list {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #666;
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="container">
        <h1 class="logo"><a href="index.html">joyban Admin</a></h1>
        <button class="mobile-menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <nav class="main-nav">
          <ul class="menu-links">
            <li><a href="board.html?category=aiworld">AIworld</a></li>
            <li><a href="board.html?category=works">Works</a></li>
            <li><a href="board.html?category=vision">Vision</a></li>
            <li><a href="board.html?category=skillup">SkillUp</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container">
      <div class="write-container">
        <h2 id="pageTitle">ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</h2>
        <form id="writeForm" enctype="multipart/form-data">
          <input type="hidden" name="id" id="postId" />
          <div class="form-group">
            <label for="category">ì¹´í…Œê³ ë¦¬</label>
            <select name="category" id="category" class="form-control" required>
              <option value="ailand">AIland</option>
              <option value="works">Works</option>
              <option value="vision">Vision</option>
              <option value="job">Job</option>
              <option value="profile">Profile</option>
            </select>
          </div>
          <div class="form-group">
            <label for="title">ì œëª©</label>
            <input
              type="text"
              name="title"
              id="title"
              class="form-control"
              required
              placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div class="form-group">
            <label for="content">ë‚´ìš©</label>
            <textarea
              name="content"
              id="content"
              class="form-control"
              required
              placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="files">íŒŒì¼ ì²¨ë¶€ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
            <input
              type="file"
              name="files[]"
              id="files"
              class="form-control"
              multiple
              accept="image/*,video/*,application/pdf"
            />
            <div class="file-list" id="fileList"></div>
            <div id="existingFiles" style="margin-top: 10px; color: #666"></div>
          </div>
          <button type="submit" class="btn-submit">ì €ì¥í•˜ê¸°</button>
        </form>
      </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get("id");

        if (postId) {
          document.getElementById("pageTitle").textContent = "ê²Œì‹œê¸€ ìˆ˜ì •";
          document.getElementById("postId").value = postId;
          await loadPostData(postId);
        }
      });

      async function loadPostData(id) {
        try {
          const response = await fetch(`api/posts/detail.php?id=${id}`);
          const result = await response.json();

          if (result.status === "success") {
            const post = result.data;
            document.getElementById("category").value = post.category;
            document.getElementById("title").value = post.title;
            document.getElementById("content").value = post.content;

            // ê¸°ì¡´ íŒŒì¼ ëª©ë¡ í‘œì‹œ (ì‚­ì œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ í•„ìš” ì‹œ ì¶”ê°€)
            if (post.media && post.media.length > 0) {
              const existingDiv = document.getElementById("existingFiles");
              existingDiv.innerHTML = "<strong>ê¸°ì¡´ ì²¨ë¶€íŒŒì¼:</strong><br>";
              post.media.forEach((file) => {
                existingDiv.innerHTML += `ğŸ“„ ${file.original_name}<br>`;
              });
            }
          } else {
            UIManager.showToast("ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
            setTimeout(() => (location.href = "index.html"), 1000);
          }
        } catch (error) {
          console.error("Error loading post:", error);
        }
      }

      document
        .getElementById("writeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const postId = document.getElementById("postId").value;
          const url = postId ? "api/posts/update.php" : "api/posts/create.php";

          try {
            const response = await fetch(url, {
              method: "POST",
              body: formData,
            });
            const result = await response.json();

            if (result.status === "success") {
              UIManager.showToast(
                postId
                  ? "ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
                  : "ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
                "success"
              );
              const category = document.getElementById("category").value;
              setTimeout(() => {
                location.href = postId
                  ? `view.html?id=${result.post_id}`
                  : `board.html?category=${category}`;
              }, 1000);
            } else {
              UIManager.showToast("ì˜¤ë¥˜: " + result.message, "error");
            }
          } catch (error) {
            UIManager.showToast(
              "ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ ë˜ì–´ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.",
              "error"
            );
          }
        });

      // íŒŒì¼ ì„ íƒ ì‹œ ëª©ë¡ í‘œì‹œ
      document.getElementById("files").addEventListener("change", (e) => {
        const list = document.getElementById("fileList");
        list.innerHTML = "";
        for (const file of e.target.files) {
          const item = document.createElement("div");
          item.textContent = file.name;
          list.appendChild(item);
        }
      });
    </script>
    <script src="js/app.js"></script>
  </body>
</html>
